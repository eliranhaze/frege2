function t(t){if(this.fs=[null],this.symbols=[""],this.nl=[0],this.ns=[],this.rs=[],t)for(var i in t)this[i]=t[i]}function i(t,i,e,r,o){a=null,r?t.text()==l?n(i,e,r)&&f(t):(f(t),s(e)&&(c(t),a=t)):n(i,e,r,o),t.blur()}function n(t,i,n,r){if(s(i,r)){var o=h();if(n){var u=p();if(!u)return errmsg("יש להזין נוסחה");try{var c=new Formula(u)}catch(t){return errmsg(t.message)}o.push(c)}try{var f=t.apply(dd,o)}catch(t){return errmsg(t.message)}if(f){f instanceof Array||(f=[f]);for(var a=0;a<f.length;a++)addRow(f[a].lit,dd.symbols[dd.symbols.length-1],dd.idx()-f.length+a+1);return e(),$.notifyClose(),!0}return i>0?errmsg("לא ניתן להשתמש בכלל זה עבור השורות שנבחרו"):errmsg("לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function e(){$("input[type=checkbox]").prop("checked",!1)}function s(t,i){if(t>0){var n=h();if(n.length!=t){var s=["","שורה אחת","שתי שורות","שלוש שורות"];return errmsg("יש לבחור "+s[t]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(i)return!0;for(var r=0;r<n.length;r++)if(!dd.ic(n[r]))return errmsg("שורה "+n[r]+" מחוץ לרמה הנוכחית"),!1}else e();return!0}function addRow(t,i,n){for(var e="r"+n,s=dd.nl[n],r=0;r<s;r++)t=o(t,n,s-r);if($("#deduction tr:last").after('<tr id="'+e+'"><td class="dd-num""><input type="checkbox" id="cb'+n+'" name="'+n+'" onclick="oc()">'+n+'. </input></td><td id="f'+n+'">'+t+'</td><td class="dd-just">'+i+"</td></tr>"),n>1){var h=dd.nl[n-1];h>s&&u(n-1,h)}}function r(){var t=dd.idx();if("prem"!=dd.symbols[t]&&0!=$("#r"+t).length){$("#r"+t).remove(),e();var i=dd.nesting();dd.pop(),dd.nesting()>i&&u(dd.idx(),dd.nesting())}}function o(t,i,n){return'<div class="dd-hyp" id="nst'+i+n+'">'+t+"</div>"}function u(t,i){$("#nst"+t+i).toggleClass("dd-hyp-end")}function h(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function c(t){$("#extra").css("opacity","1"),setTimeout(function(){$("#ftxt").focus()},5),$("#ftxt").on("input",function(){t.data("symbol")||t.data("symbol",t.text()),t.removeClass("btn-default"),t.addClass("btn-primary"),t.text(l)}),$(document).keypress(function(i){13==i.which&&t.click()})}function f(t){$("#extra").css("opacity","0"),$("#ftxt").val(""),$("#ftxt").off("input"),$(document).off("keypress"),t&&(t.addClass("btn-default"),t.removeClass("btn-primary"),t.text(t.data("symbol")))}function p(){return $("#ftxt").val()}function oc(){f(a)}t.prototype.idx=function(){return this.fs.length-1},t.prototype.nesting=function(){return this.ns.length},t.prototype.oi=function(){return this.ns[this.ns.length-1]},t.prototype.push=function(t,i,n,e){this.fs.push(t),this.symbols.push(i),n?this.ns.push(this.idx()):e&&this.rs.push(this.ns.pop()),this.nl.push(this.nesting())},t.prototype.pop=function(){if(0!=this.idx()){var t=this.nesting(),i=this.idx();this.fs.pop(),this.symbols.pop(),this.nl.pop(),this.nl[this.idx()]!=t&&(this.oi()==i?this.ns.pop():this.ns.push(this.rs.pop()))}},t.prototype.io=function(t){var i=this.nl[t];if(i>0&&i<=this.nesting()){var n=this.ns[i-1];return t>=n}return!1},t.prototype.ic=function(t){var i=this.nesting();return i==this.nl[t]&&(0==i||this.io(t))},t.prototype.get=function(t){if(t>0&&t<=this.idx())return this.fs[t]},t.prototype.toString=function(){for(var t="",i=1;i<this.fs.length;i++)t+="["+this.nl[i]+"] "+i+". "+this.fs[i]+"\n";return t},t.prototype.impE=function(t,i){if(this.ic(t)&&this.ic(i)){_impE=function(t,i){if(t&&t.con==IMP&&t.s1.eq(i))return t.s2};var n=this.get(t),e=this.get(i),s=_impE(n,e);return s||(s=_impE(e,n)),s?(this.push(s,"E "+IMP+" "+t+","+i),s):void 0}},t.prototype.conE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==CON){var n=[i.s1,i.s2];return this.push(n[0],"E "+CON+" "+t),this.push(n[1],"E "+CON+" "+t),n}}},t.prototype.disE=function(t,i,n){if(this.ic(t)&&this.ic(i)&&this.ic(n)){_disE=function(t,i,n){if(i.s2.eq(n.s2)&&t.eq(i.s1.cm(n.s1,DIS)))return i.s2};var e=this.get(t),s=this.get(i),r=this.get(n),o=null;if(e&&s&&r){if(e.con==DIS&&s.con==IMP&&r.con==IMP)o=_disE(e,s,r);else if(s.con==DIS&&e.con==IMP&&r.con==IMP)o=_disE(s,e,r);else{if(r.con!=DIS||s.con!=IMP||e.con!=IMP)return;o=_disE(r,s,e)}return this.push(o,"E "+DIS+" "+t+","+i+","+n),o}}},t.prototype.eqvE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==EQV){var n=[i.s1.cm(i.s2,IMP),i.s2.cm(i.s1,IMP)];return this.push(n[0],"E "+EQV+" "+t),this.push(n[1],"E "+EQV+" "+t),n}}},t.prototype.negE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==NEG&&i.s1.con==NEG){var n=i.s1.s1;return this.push(n,"E "+NEG+" "+t),n}}},t.prototype.conI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.get(t),e=this.get(i);if(n&&e){var s=n.cm(e,CON);return this.push(s,"I "+CON+" "+t+","+i),s}}},t.prototype.disI=function(t,i){if(this.ic(t)){var n=this.get(t);if(n&&i){var e=n.cm(i,DIS);return this.push(e,"I "+DIS+" "+t),e}}},t.prototype.eqvI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.get(t),e=this.get(i);if(n&&e&&n.con==IMP&&e.con==IMP&&n.s1.eq(e.s2)&&e.s1.eq(n.s2)){var s=n.s1.cm(n.s2,EQV);return this.push(s,"I "+EQV+" "+t+","+i),s}}},t.prototype.impI=function(){if(this.nesting()>0){var t=this.get(this.oi()),i=this.get(this.idx());if(t&&i){var n=t.cm(i,IMP);return this.push(n,"I "+IMP+" "+this.oi()+"-"+this.idx(),!1,!0),n}}},t.prototype.negI=function(){if(this.nesting()>0){var t=this.get(this.oi()),i=this.get(this.idx());if(t&&i&&i.icn()){var n=t.ng();return this.push(n,"I "+NEG+" "+this.oi()+"-"+this.idx(),!1,!0),n}}},t.prototype.hyp=function(t){return this.push(t,"hyp",!0),t},t.prototype.rep=function(t){var i=this.get(t);if(i){if(this.ic(t))throw Error("שורה "+t+" כבר נמצאת ברמה הנוכחית");if(this.nl[t]>0&&!this.io(t))throw Error("שורה "+t+" נמצאת בתת הוכחה אחרת");return this.push(i,"rep "+t),i}};var dd=new t,a=null,l="OK";$(document).ready(function(){$("#imp-e").click(function(){i($(this),dd.impE,2)}),$("#con-e").click(function(){i($(this),dd.conE,1)}),$("#dis-e").click(function(){i($(this),dd.disE,3)}),$("#eqv-e").click(function(){i($(this),dd.eqvE,1)}),$("#neg-e").click(function(){i($(this),dd.negE,1)}),$("#imp-i").click(function(){i($(this),dd.impI,0)}),$("#con-i").click(function(){i($(this),dd.conI,2)}),$("#dis-i").click(function(){i($(this),dd.disI,1,!0)}),$("#eqv-i").click(function(){i($(this),dd.eqvI,2)}),$("#neg-i").click(function(){i($(this),dd.negI,0)}),$("#hyp").click(function(){i($(this),dd.hyp,0,!0)}),$("#rep").click(function(){i($(this),dd.rep,1,!1,!0)}),$("#rem").click(function(){r(),$(this).blur()})});
