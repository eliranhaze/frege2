function t(t,i){this.con=null,this.s1=null,this.s2=null,this.l=s(t),this.an(this.l)}function i(t){return t.toLowerCase()!=t.toUpperCase()}function n(t){return t==k||t==S||t==E||t==w}function e(t){return t==k||t==S||t==w}function s(t){return r(t).replace(/ /g,"")}function r(t){if("("==t.charAt(0)&&")"==t.charAt(t.length-1))for(var i=0,n=0;n<t.length;n++){var e=t.charAt(n);if(")"==e){if(i--,0==i)return n==t.length-1?r(t.slice(1,t.length-1)):t}else"("==e&&i++}return t}function o(){this.fs=[null],this.nl=[0],this.ns=[],this.rs=[],this.ls=""}function u(t,i,n,e,s){L=null,e?t.text()==O?h(i,n,e)&&d(t):(d(t),l(n)&&(m(t),L=t)):h(i,n,e,s),t.blur()}function h(i,n,e,s){if(l(n,s)){var r=g();if(e){var o=y();if(!o)return errmsg("יש להזין נוסחה");try{var u=new t(o)}catch(t){return errmsg(t.message)}r.push(u)}var h=C.N();try{var f=i.apply(C,r)}catch(t){return errmsg(t.message)}if(f){f instanceof Array||(f=[f]);for(var a=0;a<f.length;a++)addRow(f[a].l,C.ls,!1,C.ix()-f.length+a+1);return h>C.N()&&v(C.ix()-1,h),c(),$.notifyClose(),!0}return n>0?errmsg("לא ניתן להשתמש בכלל זה עבור השורות שנבחרו"):errmsg("לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function c(){$("input[type=checkbox]").prop("checked",!1)}function l(t,i){if(t>0){var n=g();if(n.length!=t){var e=["","שורה אחת","שתי שורות","שלוש שורות"];return errmsg("יש לבחור "+e[t]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(i)return!0;for(var s=0;s<n.length;s++)if(!C.ic(n[s]))return errmsg("שורה "+n[s]+" מחוץ לרמה הנוכחית"),!1}else c();return!0}function addRow(i,n,e,s){if(e){var r="";n="prem",C.push(new t(i)),s=C.ix()}else var r="r"+s;for(var o=C.N(),u=0;u<o;u++)i=p(i,s,o-u);$("#deduction tr:last").after('<tr id="'+r+'"><td class="dd-num""><input type="checkbox" id="cb'+s+'" name="'+s+'" onclick="oc()">'+s+'. </input></td><td id="f'+s+'">'+i+'</td><td class="dd-just">'+n+"</td></tr>")}function a(){var t=C.ix();if(0!=$("#r"+t).length){$("#r"+t).remove(),c();var i=C.N();C.pop(),C.N()>i&&v(C.ix(),C.N())}}function p(t,i,n){return'<div class="dd-hyp" id="nst'+i+n+'">'+t+"</div>"}function v(t,i){$("#nst"+t+i).toggleClass("dd-hyp-end")}function g(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function m(t){$("#extra").css("opacity","1"),setTimeout(function(){$("#extxt").focus()},5),$("#extxt").on("input",function(){t.data("symbol")||t.data("symbol",t.text()),t.removeClass("btn-default"),t.addClass("btn-primary"),t.text(O)}),$(document).keypress(function(i){13==i.which&&t.click()})}function d(t){$("#extra").css("opacity","0"),$("#extxt").val(""),$("#extxt").off("input"),$(document).off("keypress"),t&&(t.addClass("btn-default"),t.removeClass("btn-primary"),t.text(t.data("symbol")))}function y(){return $("#extxt").val()}function oc(){d(L)}function x(t){$("#extxt").insertAtCaret(t),$("#extxt").focus()}var b="~",k="·",S="∨",E="⊃",w="≡";t.prototype.an=function(e){if(!this.ia()){for(var s="נוסחה לא תקינה",r=!1,o=0,u=0;u<e.length;u++){var h=e.charAt(u);if(")"==h)o--;else if("("==h){if(o++,u+1<e.length){var c=e.charAt(u+1);if(!i(c)&&c!=b&&"("!=c)throw new Error(s)}}else if(0==o){if(n(h)){var f=e.slice(0,u),l=e.slice(u+1);if(this.con=h,this.s1=new t(f),this.s2=new t(l),!this.s1.vs(f)||!this.s2.vs(l))throw new Error(s);return}h==b&&(r=!0)}else if(o<0)throw new Error("סוגריים לא מאוזנים")}if(0!==o)throw new Error("סוגריים לא מאוזנים");if(r){var a=e.slice(1);if(e.charAt(0)!==b)throw new Error(s);return this.con=b,void(this.s1=new t(a))}throw new Error(s)}},t.prototype.ia=function(){return 1==this.l.length&&i(this.l)},t.prototype.icn=function(){return this.con==k&&(this.s1.ing(this.s2)||this.s2.ing(this.s1))},t.prototype.ing=function(t){return this.con==b&&this.s1.eq(t)},t.prototype.eq=function(t){if(!t)return!1;if(this.l==t.l)return!0;if(this.ia())return!1;if(this.con==t.con){if(!n(this.con))return this.s1.eq(t.s1);if(this.s1.eq(t.s1)&&this.s2.eq(t.s2))return!0;if(e(this.con))return this.s1.eq(t.s2)&&this.s2.eq(t.s1)}return!1},t.prototype.cm=function(i,e){if(n(e))return f=new t("p"),f.con=e,f.s1=this,f.s2=i,f.l=this.wr()+e+i.wr(),f},t.prototype.ng=function(){return f=new t("p"),f.con=b,f.s1=this,f.l=b+this.wr(),f},t.prototype.wr=function(){return n(this.con)?"("+this.l+")":this.l},t.prototype.vs=function(t){return this.ia()||!n(this.con)||t!==r(t)},t.prototype.toString=function(){return this.l},o.prototype.ix=function(){return this.fs.length-1},o.prototype.N=function(){return this.ns.length},o.prototype.oi=function(){return this.ns[this.ns.length-1]},o.prototype.push=function(t,i,n){this.fs.push(t),i?this.ns.push(this.ix()):n&&this.rs.push(this.ns.pop()),this.nl.push(this.N())},o.prototype.pop=function(){if(0!=this.ix()){var t=this.N(),i=this.ix();this.fs.pop(),this.nl.pop(),this.nl[this.ix()]!=t&&(this.oi()==i?this.ns.pop():this.ns.push(this.rs.pop()))}},o.prototype.io=function(t){var i=this.nl[t];if(i>0&&i<=this.N()){var n=this.ns[i-1];return t>=n}return!1},o.prototype.ic=function(t){var i=this.N();return i==this.nl[t]&&(0==i||this.io(t))},o.prototype.gf=function(t){if(t>0&&t<=this.ix())return this.fs[t]},o.prototype.toString=function(){for(var t="",i=1;i<this.fs.length;i++)t+="["+this.nl[i]+"] "+i+". "+this.fs[i]+"\n";return t},o.prototype.impE=function(t,i){if(this.ic(t)&&this.ic(i)){_impE=function(t,i){if(t&&t.con==E&&t.s1.eq(i))return t.s2};var n=this.gf(t),e=this.gf(i),s=_impE(n,e);return s||(s=_impE(e,n)),s?(this.ls="E "+E+" "+t+","+i,this.push(s),s):void 0}},o.prototype.conE=function(t){if(this.ic(t)){var i=this.gf(t);if(i&&i.con==k){var n=[i.s1,i.s2];return this.ls="E "+k+" "+t,this.push(n[0]),this.push(n[1]),n}}},o.prototype.disE=function(t,i,n){if(this.ic(t)&&this.ic(i)&&this.ic(n)){_disE=function(t,i,n){if(i.s2.eq(n.s2)&&t.eq(i.s1.cm(n.s1,S)))return i.s2};var e=this.gf(t),s=this.gf(i),r=this.gf(n),o=null;if(e&&s&&r){if(e.con==S&&s.con==E&&r.con==E)o=_disE(e,s,r);else if(s.con==S&&e.con==E&&r.con==E)o=_disE(s,e,r);else{if(r.con!=S||s.con!=E||e.con!=E)return;o=_disE(r,s,e)}return this.ls="E "+S+" "+t+","+i+","+n,this.push(o),o}}},o.prototype.eqvE=function(t){if(this.ic(t)){var i=this.gf(t);if(i&&i.con==w){var n=[i.s1.cm(i.s2,E),i.s2.cm(i.s1,E)];return this.ls="E "+w+" "+t,this.push(n[0]),this.push(n[1]),n}}},o.prototype.negE=function(t){if(this.ic(t)){var i=this.gf(t);if(i&&i.con==b&&i.s1.con==b){var n=i.s1.s1;return this.ls="E "+b+" "+t,this.push(n),n}}},o.prototype.conI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.gf(t),e=this.gf(i);if(n&&e){var s=n.cm(e,k);return this.ls="I "+k+" "+t+","+i,this.push(s),s}}},o.prototype.disI=function(t,i){if(this.ic(t)){var n=this.gf(t);if(n&&i){var e=n.cm(i,S);return this.ls="I "+S+" "+t,this.push(e),e}}},o.prototype.eqvI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.gf(t),e=this.gf(i);if(n&&e&&n.con==E&&e.con==E&&n.s1.eq(e.s2)&&e.s1.eq(n.s2)){var s=n.s1.cm(n.s2,w);return this.ls="I "+w+" "+t+","+i,this.push(s),s}}},o.prototype.impI=function(){if(this.N()>0){var t=this.gf(this.oi()),i=this.gf(this.ix());if(t&&i){var n=t.cm(i,E);return this.ls="I "+E+" "+this.oi()+"-"+this.ix(),this.push(n,!1,!0),n}}},o.prototype.negI=function(){if(this.N()>0){var t=this.gf(this.oi()),i=this.gf(this.ix());if(t&&i&&i.icn()){var n=t.ng();return this.ls="I "+b+" "+this.oi()+"-"+this.ix(),this.push(n,!1,!0),n}}},o.prototype.hyp=function(t){return this.ls="hyp",this.push(t,!0),t},o.prototype.rep=function(t){var i=this.gf(t);if(i){if(this.ic(t))throw Error("שורה "+t+" כבר נמצאת ברמה הנוכחית");if(this.nl[t]>0&&!this.io(t))throw Error("שורה "+t+" נמצאת בתת הוכחה אחרת");return this.ls="rep "+t,this.push(i),i}};var C=new o,L=null,O="OK";jQuery.fn.extend({insertAtCaret:function(t){return this.each(function(i){if(document.selection){this.focus();var n=document.selection.createRange();n.text=t,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var e=this.selectionStart,s=this.selectionEnd,r=this.scrollTop;this.value=this.value.substring(0,e)+t+this.value.substring(s,this.value.length),this.focus(),this.selectionStart=e+t.length,this.selectionEnd=e+t.length,this.scrollTop=r}else this.value+=t,this.focus()})}}),$(document).ready(function(){$("#imp-e").click(function(){u($(this),C.impE,2)}),$("#con-e").click(function(){u($(this),C.conE,1)}),$("#dis-e").click(function(){u($(this),C.disE,3)}),$("#eqv-e").click(function(){u($(this),C.eqvE,1)}),$("#neg-e").click(function(){u($(this),C.negE,1)}),$("#imp-i").click(function(){u($(this),C.impI,0)}),$("#con-i").click(function(){u($(this),C.conI,2)}),$("#dis-i").click(function(){u($(this),C.disI,1,!0)}),$("#eqv-i").click(function(){u($(this),C.eqvI,2)}),$("#neg-i").click(function(){u($(this),C.negI,0)}),$("#hyp").click(function(){u($(this),C.hyp,0,!0)}),$("#rep").click(function(){u($(this),C.rep,1,!1,!0)}),$("#rem").click(function(){a(),$(this).blur()}),$("#neg").click(function(){x("~")}),$("#con").click(function(){x("·")}),$("#dis").click(function(){x("∨")}),$("#imp").click(function(){x("⊃")}),$("#eqv").click(function(){x("≡")})});
