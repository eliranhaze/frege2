function t(){this.fs=[null],this.nl=[0],this.ns=[],this.rs=[],this.ls=""}function i(t,i,s,r,o){l=null,r?t.text()==a?n(i,s,r)&&f(t):(f(t),e(s)&&(c(t),l=t)):n(i,s,r,o),t.blur()}function n(t,i,n,r){if(e(i,r)){var o=u();if(n){var c=p();if(!c)return errmsg("יש להזין נוסחה");try{var f=new Formula(c)}catch(t){return errmsg(t.message)}o.push(f)}var l=dd.nesting();try{var a=t.apply(dd,o)}catch(t){return errmsg(t.message)}if(a){a instanceof Array||(a=[a]);for(var v=0;v<a.length;v++)addRow(a[v].lit,dd.ls,!1,dd.idx()-a.length+v+1);return l>dd.nesting()&&h(dd.idx()-1,l),s(),$.notifyClose(),!0}return i>0?errmsg("לא ניתן להשתמש בכלל זה עבור השורות שנבחרו"):errmsg("לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function s(){$("input[type=checkbox]").prop("checked",!1)}function e(t,i){if(t>0){var n=u();if(n.length!=t){var e=["","שורה אחת","שתי שורות","שלוש שורות"];return errmsg("יש לבחור "+e[t]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(i)return!0;for(var r=0;r<n.length;r++)if(!dd.ic(n[r]))return errmsg("שורה "+n[r]+" מחוץ לרמה הנוכחית"),!1}else s();return!0}function addRow(t,i,n,s){if(n){var e="";i="prem",dd.push(new Formula(t)),s=dd.idx()}else var e="r"+s;for(var r=dd.nesting(),h=0;h<r;h++)t=o(t,s,r-h);$("#deduction tr:last").after('<tr id="'+e+'"><td class="dd-num""><input type="checkbox" id="cb'+s+'" name="'+s+'" onclick="oc()">'+s+'. </input></td><td id="f'+s+'">'+t+'</td><td class="dd-just">'+i+"</td></tr>")}function r(){var t=dd.idx();if(0!=$("#r"+t).length){$("#r"+t).remove(),s();var i=dd.nesting();dd.pop(),dd.nesting()>i&&h(dd.idx(),dd.nesting())}}function o(t,i,n){return'<div class="dd-hyp" id="nst'+i+n+'">'+t+"</div>"}function h(t,i){$("#nst"+t+i).toggleClass("dd-hyp-end")}function u(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function c(t){$("#extra").css("opacity","1"),setTimeout(function(){$("#ftxt").focus()},5),$("#ftxt").on("input",function(){t.data("symbol")||t.data("symbol",t.text()),t.removeClass("btn-default"),t.addClass("btn-primary"),t.text(a)}),$(document).keypress(function(i){13==i.which&&t.click()})}function f(t){$("#extra").css("opacity","0"),$("#ftxt").val(""),$("#ftxt").off("input"),$(document).off("keypress"),t&&(t.addClass("btn-default"),t.removeClass("btn-primary"),t.text(t.data("symbol")))}function p(){return $("#ftxt").val()}function oc(){f(l)}t.prototype.idx=function(){return this.fs.length-1},t.prototype.nesting=function(){return this.ns.length},t.prototype.oi=function(){return this.ns[this.ns.length-1]},t.prototype.push=function(t,i,n){this.fs.push(t),i?this.ns.push(this.idx()):n&&this.rs.push(this.ns.pop()),this.nl.push(this.nesting())},t.prototype.pop=function(){if(0!=this.idx()){var t=this.nesting(),i=this.idx();this.fs.pop(),this.nl.pop(),this.nl[this.idx()]!=t&&(this.oi()==i?this.ns.pop():this.ns.push(this.rs.pop()))}},t.prototype.io=function(t){var i=this.nl[t];if(i>0&&i<=this.nesting()){var n=this.ns[i-1];return t>=n}return!1},t.prototype.ic=function(t){var i=this.nesting();return i==this.nl[t]&&(0==i||this.io(t))},t.prototype.get=function(t){if(t>0&&t<=this.idx())return this.fs[t]},t.prototype.toString=function(){for(var t="",i=1;i<this.fs.length;i++)t+="["+this.nl[i]+"] "+i+". "+this.fs[i]+"\n";return t},t.prototype.impE=function(t,i){if(this.ic(t)&&this.ic(i)){_impE=function(t,i){if(t&&t.con==IMP&&t.s1.eq(i))return t.s2};var n=this.get(t),s=this.get(i),e=_impE(n,s);return e||(e=_impE(s,n)),e?(this.ls="E "+IMP+" "+t+","+i,this.push(e),e):void 0}},t.prototype.conE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==CON){var n=[i.s1,i.s2];return this.ls="E "+CON+" "+t,this.push(n[0]),this.push(n[1]),n}}},t.prototype.disE=function(t,i,n){if(this.ic(t)&&this.ic(i)&&this.ic(n)){_disE=function(t,i,n){if(i.s2.eq(n.s2)&&t.eq(i.s1.cm(n.s1,DIS)))return i.s2};var s=this.get(t),e=this.get(i),r=this.get(n),o=null;if(s&&e&&r){if(s.con==DIS&&e.con==IMP&&r.con==IMP)o=_disE(s,e,r);else if(e.con==DIS&&s.con==IMP&&r.con==IMP)o=_disE(e,s,r);else{if(r.con!=DIS||e.con!=IMP||s.con!=IMP)return;o=_disE(r,e,s)}return this.ls="E "+DIS+" "+t+","+i+","+n,this.push(o),o}}},t.prototype.eqvE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==EQV){var n=[i.s1.cm(i.s2,IMP),i.s2.cm(i.s1,IMP)];return this.ls="E "+EQV+" "+t,this.push(n[0]),this.push(n[1]),n}}},t.prototype.negE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==NEG&&i.s1.con==NEG){var n=i.s1.s1;return this.ls="E "+NEG+" "+t,this.push(n),n}}},t.prototype.conI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.get(t),s=this.get(i);if(n&&s){var e=n.cm(s,CON);return this.ls="I "+CON+" "+t+","+i,this.push(e),e}}},t.prototype.disI=function(t,i){if(this.ic(t)){var n=this.get(t);if(n&&i){var s=n.cm(i,DIS);return this.ls="I "+DIS+" "+t,this.push(s),s}}},t.prototype.eqvI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.get(t),s=this.get(i);if(n&&s&&n.con==IMP&&s.con==IMP&&n.s1.eq(s.s2)&&s.s1.eq(n.s2)){var e=n.s1.cm(n.s2,EQV);return this.ls="I "+EQV+" "+t+","+i,this.push(e),e}}},t.prototype.impI=function(){if(this.nesting()>0){var t=this.get(this.oi()),i=this.get(this.idx());if(t&&i){var n=t.cm(i,IMP);return this.ls="I "+IMP+" "+this.oi()+"-"+this.idx(),this.push(n,!1,!0),n}}},t.prototype.negI=function(){if(this.nesting()>0){var t=this.get(this.oi()),i=this.get(this.idx());if(t&&i&&i.icn()){var n=t.ng();return this.ls="I "+NEG+" "+this.oi()+"-"+this.idx(),this.push(n,!1,!0),n}}},t.prototype.hyp=function(t){return this.ls="hyp",this.push(t,!0),t},t.prototype.rep=function(t){var i=this.get(t);if(i){if(this.ic(t))throw Error("שורה "+t+" כבר נמצאת ברמה הנוכחית");if(this.nl[t]>0&&!this.io(t))throw Error("שורה "+t+" נמצאת בתת הוכחה אחרת");return this.ls="rep "+t,this.push(i),i}};var dd=new t,l=null,a="OK";$(document).ready(function(){$("#imp-e").click(function(){i($(this),dd.impE,2)}),$("#con-e").click(function(){i($(this),dd.conE,1)}),$("#dis-e").click(function(){i($(this),dd.disE,3)}),$("#eqv-e").click(function(){i($(this),dd.eqvE,1)}),$("#neg-e").click(function(){i($(this),dd.negE,1)}),$("#imp-i").click(function(){i($(this),dd.impI,0)}),$("#con-i").click(function(){i($(this),dd.conI,2)}),$("#dis-i").click(function(){i($(this),dd.disI,1,!0)}),$("#eqv-i").click(function(){i($(this),dd.eqvI,2)}),$("#neg-i").click(function(){i($(this),dd.negI,0)}),$("#hyp").click(function(){i($(this),dd.hyp,0,!0)}),$("#rep").click(function(){i($(this),dd.rep,1,!1,!0)}),$("#rem").click(function(){r(),$(this).blur()})});
