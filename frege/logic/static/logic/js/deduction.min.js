function n(){pn=[],mn=[],mn[0]=0,gn=null}function t(){return pn.length}function r(){return parseInt(pn[pn.length-1])}function i(){H(),gn=parseInt(pn.pop()),c()}function e(){pn.push(kn+1),c()}function c(){mn[kn+1]=t()}function f(n){return pn.length>0&&parseInt(n)>=pn[0]}function u(n){var r=t();return r===o(n)&&(0===r||f(n))}function o(n){n=parseInt(n);var t=0;for(row in mn)row=parseInt(row),row>t&&row<=n&&(t=row);return mn[t]}function s(n,t){var r=T(n),i=T(t),e=a(r,i);return e?e:a(i,r)}function a(n,t){if(n.con===dn&&q(n.sf1,t.lit))return L(n.sf2)}function l(n){var t=T(n);if(t.con===hn)return[L(t.sf1),L(t.sf2)]}function h(n,t,r){var i=T(n),e=T(t),c=T(r);return i.con===vn&&e.con===dn&&c.con===dn?v(i,e,c):e.con===vn&&i.con===dn&&c.con===dn?v(e,i,c):c.con===vn&&e.con===dn&&i.con===dn?v(c,e,i):void 0}function v(n,t,r){if(q(t.sf2,r.sf2)&&(q(n.sf1,t.sf1)&&q(n.sf2,r.sf1)||q(n.sf1,r.sf1)&&q(n.sf2,t.sf1)))return L(t.sf2)}function d(n){var t=T(n);if(t.con===$n)return[t.sf1+dn+t.sf2,t.sf2+dn+t.sf1]}function p(n){var t=T(n);if(t.con===ln){var r=T(t.sf1);if(r.con===ln)return L(r.sf1)}}function m(){if(t()>0){var n=en([r(),kn]);return i(),Q(n[0])+dn+Q(n[1])}}function g(n,t){return Q(n)+hn+Q(t)}function k(n,t){return Q(n)+vn+Q(t)}function x(n,t){var r=T(n),i=T(t);if(r.con===dn&&i.con===dn&&q(r.sf1,i.sf2)&&q(r.sf2,i.sf1))return r.sf1+$n+r.sf2}function y(){if(t()>0){var n=en([r(),kn]);if(E(n[1]))return i(),ln+Q(n[0])}}function b(n){return e(),n}function C(n){return n}function w(n){var t={valid:!1,lit:"",err:""},r=j(n);if(A(r))t.valid=!0,t.lit=r;else{var i=T(r);""==i.con?(t.valid=!1,t.err=i.err):(t.valid=!0,t.lit=i.lit)}return t}function I(n){return A(n)||!K(T(n).con)||n!==L(n)}function A(n){return 1===n.length&&n===n.toLowerCase()&&n.toLowerCase()!==n.toUpperCase()}function E(n){var t=T(n);if(t.con===hn){var r=T(t.sf1),i=T(t.sf2);return S(r,i)||S(i,r)}return!1}function S(n,t){return n.con===ln&&q(n.sf1,t.lit)}function q(n,t){var r=T(n),i=T(t);if(r.lit===i.lit)return!0;if(A(n))return!1;if(r.con===i.con){if(q(r.sf1,i.sf1)&&q(r.sf2,i.sf2))return!0;if(O(r.con))return q(r.sf1,i.sf2)&&q(r.sf2,i.sf1)}return!1}function T(n){var t=j(n),r={lit:t,con:"",sf1:"",sf2:""};if(A(t))return r;for(var i="נוסחה לא תקינה",e=!1,c=0,f=0;f<t.length;f++){var u=t.charAt(f);if(")"===u)c--;else if("("===u){if(c++,f+1<t.length){var o=t.charAt(f+1);if(!A(o)&&o!==ln&&"("!==o)return r.err=i,r}}else if(0===c){if(K(u)){var s=t.slice(0,f),a=t.slice(f+1);return I(s)&&I(a)&&w(s).valid&&w(a).valid?(r.con=u,r.sf1=s,r.sf2=a,r):(r.err=i,r)}u===ln&&(e=!0)}else if(c<0)return r.err="סוגריים לא מאוזנים",r}if(0!==c)return r.err="סוגריים לא מאוזנים",r;if(e){var l=t.slice(1);return t.charAt(0)===ln&&w(l).valid?(r.con=ln,r.sf1=l,r):(r.err=i,r)}return r.err=i,r}function j(n){return L(n).replace(/ /g,"")}function L(n){if("("===n.charAt(0)&&")"===n.charAt(n.length-1))for(var t=0,r=0;r<n.length;r++){var i=n.charAt(r);if(")"===i){if(t--,0===t)return r===n.length-1?L(n.slice(1,n.length-1)):n}else"("===i&&t++}return n}function K(n){return n===hn||n===vn||n===dn||n===$n}function O(n){return n===hn||n===vn||n===$n}function Q(n){return n.length>1&&T(n).con!=ln?"("+n+")":n}function R(n,t,r,i,e,c){xn=null,e?n.text()===yn?U(t,r,i,e,c)&&on(n):(on(n),z(r)&&(un(n),xn=n)):U(t,r,i,e,c),n.blur()}function U(n,t,r,i,e){if(z(t,e)){var c=cn(),f=en(c);if(i){var u=sn();if(!u)return fn("יש להזין נוסחה");var o=w(u);if(!o.valid)return fn(o.err);f.push(o.lit)}var s=n.apply(this,f);if(s){var a=r(c);s instanceof Array||(s=[s]);for(var l=0;l<s.length;l++)D(s[l],a);return _(),$.notifyClose(),!0}return fn(t>0?"לא ניתן להשתמש בכלל זה עבור השורות שנבחרו":"לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function _(){$("input[type=checkbox]").prop("checked",!1)}function z(n,t){if(n>0){var r=cn();if(r.length!=n){var i=["","שורה אחת","שתי שורות","שלוש שורות"];return fn("יש לבחור "+i[n]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(t)return B(r);for(var e=0;e<r.length;e++)if(!u(r[e]))return fn("שורה "+r[e]+" מחוץ לרמה הנוכחית"),!1}else _();return!0}function B(n){var t=n[0];return u(t)?(fn("שורה "+t+" כבר נמצאת ברמה הנוכחית"),!1):!(o(t)>0&&!f(t))||(fn("שורה "+t+" נמצאת בתת הוכחה אחרת"),!1)}function D(n,r,i){if(kn++,i){var e="";r="prem"}else var e="r"+kn;for(var c=0;c<t();c++)n=G(n,kn,t()-c);$("#deduction tr:last").after('<tr id="'+e+'"><td class="dd-num""><input type="checkbox" id="cb'+kn+'" name="'+kn+'" onclick="oncheck()">'+kn+'. </input></td><td id="f'+kn+'">'+n+'</td><td class="dd-just">'+r+"</td></tr>")}function F(){_(),$("#r"+kn).remove(),kn--}function G(n,t,r){return'<div class="dd-hyp" id="nst'+t+r+'">'+n+"</div>"}function H(){$("#nst"+kn+t()).addClass("dd-hyp-end")}function J(n){return"E ⊃ "+n[0]+","+n[1]}function M(n){return"E · "+n[0]}function N(n){return"E ∨ "+n[0]+","+n[1]+","+n[2]}function P(n){return"E ≡ "+n[0]}function V(n){return"E ~ "+n[0]}function W(){return"I ⊃ "+gn+"-"+kn}function X(n){return"I · "+n[0]+","+n[1]}function Y(n){return"I ∨ "+n[0]}function Z(n){return"I ≡ "+n[0]+","+n[1]}function nn(){return"I ~ "+gn+"-"+kn}function tn(){return"hyp"}function rn(n){return"rep "+n[0]}function en(n){for(var t=[],r=0;r<n.length;r++)t.push($("#f"+n[r]).text());return t}function cn(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function fn(n){$.notify({message:n},{allow_dismiss:!0,delay:1400,template:'<div data-notify="container" class="col-xs-11 col-sm-3 alert text-center note" role="alert"><span data-notify="dismiss"><span data-notify="message">{2}</span></span></div>'})}function un(n){$("#extra").css("opacity","1"),setTimeout(function(){$("#extxt").focus()},5),$("#extxt").on("input",function(){n.data("symbol")||n.data("symbol",n.text()),n.removeClass("btn-default"),n.addClass("btn-primary"),n.text(yn)}),$(document).keypress(function(t){13==t.which&&n.click()})}function on(n){$("#extra").css("opacity","0"),$("#extxt").val(""),$("#extxt").off("input"),$(document).off("keypress"),n&&(n.addClass("btn-default"),n.removeClass("btn-primary"),n.text(n.data("symbol")))}function sn(){return $("#extxt").val()}function oncheck(){on(xn)}function an(n){$("#extxt").insertAtCaret(n),$("#extxt").focus()}var ln="~",hn="·",vn="∨",dn="⊃",$n="≡",pn=[],mn=[],gn=null,kn=0;n();var xn=null,yn="OK";jQuery.fn.extend({insertAtCaret:function(n){return this.each(function(t){if(document.selection){this.focus();var r=document.selection.createRange();r.text=n,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var i=this.selectionStart,e=this.selectionEnd,c=this.scrollTop;this.value=this.value.substring(0,i)+n+this.value.substring(e,this.value.length),this.focus(),this.selectionStart=i+n.length,this.selectionEnd=i+n.length,this.scrollTop=c}else this.value+=n,this.focus()})}}),$(document).ready(function(){$("#imp-e").click(function(){R($(this),s,2,J)}),$("#con-e").click(function(){R($(this),l,1,M)}),$("#dis-e").click(function(){R($(this),h,3,N)}),$("#eqv-e").click(function(){R($(this),d,1,P)}),$("#neg-e").click(function(){R($(this),p,1,V)}),$("#imp-i").click(function(){R($(this),m,0,W)}),$("#con-i").click(function(){R($(this),g,2,X)}),$("#dis-i").click(function(){R($(this),k,1,Y,!0)}),$("#eqv-i").click(function(){R($(this),x,2,Z)}),$("#neg-i").click(function(){R($(this),y,0,nn)}),$("#hyp").click(function(){R($(this),b,0,tn,!0)}),$("#rep").click(function(){R($(this),C,1,rn,!1,!0)}),$("#rem").click(function(){F(),$(this).blur()}),$("#neg").click(function(){an("~")}),$("#con").click(function(){an("·")}),$("#dis").click(function(){an("∨")}),$("#imp").click(function(){an("⊃")}),$("#eqv").click(function(){an("≡")})});
