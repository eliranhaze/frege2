function n(){return gn.length}function t(){return parseInt(gn[gn.length-1])}function r(){H(),mn=parseInt(gn.pop()),e()}function i(){gn.push(parseInt(U())),e()}function e(){kn[U()]=n()}function c(n){return gn.length>0&&parseInt(n)>=gn[0]}function f(t){var r=n();return r===u(t)&&(0===r||c(t))}function u(n){n=parseInt(n);var t=0;for(line in kn)line=parseInt(line),line>t&&line<=n&&(t=line);return kn[t]}function o(n,t){return n.length>t.length?s(n,t):s(t,n)}function s(n,t){var r=q(n);if(r.con===$n&&T(r.sf1)===T(t))return T(r.sf2)}function a(n){var t=q(n);if(t.con===dn)return[T(t.sf1),T(t.sf2)]}function l(n,t,r){var i=q(n),e=q(t),c=q(r);return i.con===vn&&e.con===$n&&c.con===$n?h(i,e,c):e.con===vn&&i.con===$n&&c.con===$n?h(e,i,c):c.con===vn&&e.con===$n&&i.con===$n?h(c,e,i):void 0}function h(n,t,r){if(t.sf2===r.sf2&&(n.sf1===t.sf1&&n.sf2===r.sf1||n.sf1===r.sf1&&n.sf2===t.sf1))return T(t.sf2)}function d(n){var t=q(n);if(t.con===pn)return[t.sf1+$n+t.sf2,t.sf2+$n+t.sf1]}function v(n){var t=q(n);if(t.con===hn){var r=q(t.sf1);if(r.con===hn)return T(r.sf1)}}function p(){if(n()>0){var i=en([t(),R()]);return r(),K(i[0])+$n+K(i[1])}}function g(n,t){return K(n)+dn+K(t)}function k(n,t){return K(n)+vn+K(t)}function m(n,t){var r=q(n),i=q(t);if(r.con===$n&&i.con===$n&&r.sf1===i.sf2&&r.sf2===i.sf1)return r.sf1+pn+i.sf2}function x(){if(n()>0){var i=en([t(),R()]);if(E(i[1]))return r(),hn+K(i[0])}}function y(n){return i(),n}function b(n){return n}function C(n){var t={valid:!1,lit:"",err:""},r=T(n).replace(/ /g,"");if(A(r))t.valid=!0,t.lit=r;else{var i=q(r);""==i.con?(t.valid=!1,t.err=i.err):(t.valid=!0,t.lit=i.lit)}return t}function I(n){return A(n)||!j(q(n).con)||n!==T(n)}function A(n){return 1===n.length&&n===n.toLowerCase()&&n.toLowerCase()!==n.toUpperCase()}function E(n){var t=q(n);if(t.con===dn){var r=q(t.sf1),i=q(t.sf2);return w(r,i)||w(i,r)}return!1}function w(n,t){return n.con===hn&&S(n.sf1,t.lit)}function S(n,t){var r=q(n),i=q(t);if(r.lit===i.lit)return!0;if(A(n))return!1;if(r.con===i.con){if(S(r.sf1,i.sf1)&&S(r.sf2,i.sf2))return!0;if(L(r.con))return S(r.sf1,i.sf2)&&S(r.sf2,i.sf1)}return!1}function q(n){var t=T(n).replace(/ /g,""),r={lit:t,con:"",sf1:"",sf2:""};if(A(t))return r;for(var i="נוסחה לא תקינה",e=!1,c=0,f=0;f<t.length;f++){var u=t.charAt(f);if(")"===u)c--;else if("("===u){if(c++,f+1<t.length){var o=t.charAt(f+1);if(!A(o)&&o!==hn&&"("!==o)return r.err=i,r}}else if(0===c){if(j(u)){var s=t.slice(0,f),a=t.slice(f+1);return I(s)&&I(a)&&C(s).valid&&C(a).valid?(r.con=u,r.sf1=s,r.sf2=a,r):(r.err=i,r)}u===hn&&(e=!0)}else if(c<0)return r.err="סוגריים לא מאוזנים",r}if(0!==c)return r.err="סוגריים לא מאוזנים",r;if(e){var l=t.slice(1);return t.charAt(0)===hn&&C(l).valid?(r.con=hn,r.sf1=l,r):(r.err=i,r)}return r.err=i,r}function T(n){if("("===n.charAt(0)&&")"===n.charAt(n.length-1))for(var t=0,r=0;r<n.length;r++){var i=n.charAt(r);if(")"===i){if(t--,0===t)return r===n.length-1?T(n.slice(1,n.length-1)):n}else"("===i&&t++}return n}function j(n){return n===dn||n===vn||n===$n||n===pn}function L(n){return n===dn||n===vn||n===pn}function K(n){return n.length>1&&q(n).con!=hn?"("+n+")":n}function O(n,t,r,i,e,c){xn=null,e?n.text()===yn?Q(t,r,i,e,c)&&on(n):(on(n),z(r)&&(un(n),xn=n)):Q(t,r,i,e,c),n.blur()}function Q(n,t,r,i,e){if(z(t,e)){var c=cn(),f=en(c);if(i){var u=sn();if(!u)return fn("יש להזין נוסחה");var o=C(u);if(!o.valid)return fn(o.err);f.push(o.lit)}var s=n.apply(this,f);if(s){var a=U(),l=r(c);s instanceof Array||(s=[s]);for(var h=0;h<s.length;h++)D(a+h,s[h],l);return _(),$.notifyClose(),!0}return fn(t>0?"לא ניתן להשתמש בכלל זה עבור השורות שנבחרו":"לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function R(){return $("#deduction >tbody >tr").length}function U(){return R()+1}function _(){$("input[type=checkbox]").prop("checked",!1)}function z(n,t){if(n>0){var r=cn();if(r.length!=n){var i=["","שורה אחת","שתי שורות","שלוש שורות"];return fn("יש לבחור "+i[n]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(t)return B(r);for(var e=0;e<r.length;e++)if(!f(r[e]))return fn("שורה "+r[e]+" מחוץ לרמה הנוכחית"),!1}else _();return!0}function B(n){var t=n[0];return f(t)?(fn("שורה "+t+" כבר נמצאת ברמה הנוכחית"),!1):!(u(t)>0&&!c(t))||(fn("שורה "+t+" נמצאת בתת הוכחה אחרת"),!1)}function D(t,r,i){for(var e=0;e<n();e++)r=G(r,t,n()-e);$("#deduction tr:last").after('<tr id="row'+t+'"><td class="dd-num""><input type="checkbox" id="cb'+t+'" name="'+t+'" onclick="oncheck()">'+t+'. </input></td><td id="f'+t+'">'+r+'</td><td class="dd-just">'+i+"</td></tr>")}function F(){_(),$("#row"+R()).remove()}function G(n,t,r){return'<div class="dd-hyp" id="nst'+t+r+'">'+n+"</div>"}function H(){$("#nst"+R()+n()).addClass("dd-hyp-end")}function J(n){return"E ⊃ "+n[0]+","+n[1]}function M(n){return"E · "+n[0]}function N(n){return"E ∨ "+n[0]+","+n[1]+","+n[2]}function P(n){return"E ≡ "+n[0]}function V(n){return"E ~ "+n[0]}function W(){return"I ⊃ "+mn+"-"+R()}function X(n){return"I · "+n[0]+","+n[1]}function Y(n){return"I ∨ "+n[0]}function Z(n){return"I ≡ "+n[0]+","+n[1]}function nn(){return"I ~ "+mn+"-"+R()}function tn(){return"hyp"}function rn(n){return"rep "+n[0]}function en(n){for(var t=[],r=0;r<n.length;r++)t.push($("#f"+n[r]).text());return t}function cn(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function fn(n){$.notify({message:n},{allow_dismiss:!0,delay:1400,template:'<div data-notify="container" class="col-xs-11 col-sm-3 alert text-center note" role="alert"><span data-notify="dismiss"><span data-notify="message">{2}</span></span></div>'})}function un(n){$("#extra").css("opacity","1"),setTimeout(function(){$("#extxt").focus()},5),$("#extxt").on("input",function(){n.data("symbol")||n.data("symbol",n.text()),n.removeClass("btn-default"),n.addClass("btn-primary"),n.text(yn)}),$(document).keypress(function(t){13==t.which&&n.click()})}function on(n){$("#extra").css("opacity","0"),$("#extxt").val(""),$("#extxt").off("input"),$(document).off("keypress"),n&&(n.addClass("btn-default"),n.removeClass("btn-primary"),n.text(n.data("symbol")))}function sn(){return $("#extxt").val()}function an(){on(xn)}function ln(n){$("#extxt").insertAtCaret(n),$("#extxt").focus()}var hn="~",dn="·",vn="∨",$n="⊃",pn="≡",gn=[],kn=[];kn[0]=0;var mn=null,xn=null,yn="OK";jQuery.fn.extend({insertAtCaret:function(n){return this.each(function(t){if(document.selection){this.focus();var r=document.selection.createRange();r.text=n,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var i=this.selectionStart,e=this.selectionEnd,c=this.scrollTop;this.value=this.value.substring(0,i)+n+this.value.substring(e,this.value.length),this.focus(),this.selectionStart=i+n.length,this.selectionEnd=i+n.length,this.scrollTop=c}else this.value+=n,this.focus()})}}),$(document).ready(function(){$("#imp-e").click(function(){O($(this),o,2,J)}),$("#con-e").click(function(){O($(this),a,1,M)}),$("#dis-e").click(function(){O($(this),l,3,N)}),$("#eqv-e").click(function(){O($(this),d,1,P)}),$("#neg-e").click(function(){O($(this),v,1,V)}),$("#imp-i").click(function(){O($(this),p,0,W)}),$("#con-i").click(function(){O($(this),g,2,X)}),$("#dis-i").click(function(){O($(this),k,1,Y,!0)}),$("#eqv-i").click(function(){O($(this),m,2,Z)}),$("#neg-i").click(function(){O($(this),x,0,nn)}),$("#hyp").click(function(){O($(this),y,0,tn,!0)}),$("#rep").click(function(){O($(this),b,1,rn,!1,!0)}),$("#rem").click(function(){F(),$(this).blur()}),$("#neg").click(function(){ln("~")}),$("#con").click(function(){ln("·")}),$("#dis").click(function(){ln("∨")}),$("#imp").click(function(){ln("⊃")}),$("#eqv").click(function(){ln("≡")})});
