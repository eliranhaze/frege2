function t(t,i){this.con=null,this.sf1=null,this.sf2=null,this.lit=s(t),this.analyze(this.lit)}function i(t){return t.toLowerCase()!=t.toUpperCase()}function n(t){return t===E||t===w||t===C||t===L}function e(t){return t===E||t===w||t===L}function s(t){return r(t).replace(/ /g,"")}function r(t){if("("===t.charAt(0)&&")"===t.charAt(t.length-1))for(var i=0,n=0;n<t.length;n++){var e=t.charAt(n);if(")"===e){if(i--,0===i)return n===t.length-1?r(t.slice(1,t.length-1)):t}else"("===e&&i++}return t}function o(){this.formulas=[null],this.nestingLevels=[0],this.nestingStack=[],this.reverseStack=[],this.lastSymbol=""}function u(t,i,n,e,s){I=null,e?t.text()===F?h(i,n,e)&&x(t):(x(t),l(n)&&(y(t),I=t)):h(i,n,e,s),t.blur()}function h(i,n,e,s){if(l(n,s)){var r=g();if(e){var o=b();if(!o)return m("יש להזין נוסחה");try{var u=new t(o)}catch(t){return m(t.message)}r.push(u)}var h=O.nesting();try{var f=i.apply(O,r)}catch(t){return m(t.message)}if(f){f instanceof Array||(f=[f]);for(var p=0;p<f.length;p++)a(f[p].lit,O.lastSymbol,!1,O.index()-f.length+p+1);return h>O.nesting()&&d(O.index()-1,h),c(),$.notifyClose(),!0}return m(n>0?"לא ניתן להשתמש בכלל זה עבור השורות שנבחרו":"לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function c(){$("input[type=checkbox]").prop("checked",!1)}function l(t,i){if(t>0){var n=g();if(n.length!=t){var e=["","שורה אחת","שתי שורות","שלוש שורות"];return m("יש לבחור "+e[t]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(i)return!0;for(var s=0;s<n.length;s++)if(!O.isOnCurrentLevel(n[s]))return m("שורה "+n[s]+" מחוץ לרמה הנוכחית"),!1}else c();return!0}function a(i,n,e,s){if(e){var r="";n="prem",O.push(new t(i)),s=O.index()}else var r="r"+s;for(var o=O.nesting(),u=0;u<o;u++)i=v(i,s,o-u);$("#deduction tr:last").after('<tr id="'+r+'"><td class="dd-num""><input type="checkbox" id="cb'+s+'" name="'+s+'" onclick="oncheck()">'+s+'. </input></td><td id="f'+s+'">'+i+'</td><td class="dd-just">'+n+"</td></tr>")}function p(){var t=O.index();if(0!=$("#r"+t).length){$("#r"+t).remove(),c();var i=O.nesting();O.pop(),O.nesting()>i&&d(O.index(),O.nesting())}}function v(t,i,n){return'<div class="dd-hyp" id="nst'+i+n+'">'+t+"</div>"}function d(t,i){$("#nst"+t+i).toggleClass("dd-hyp-end")}function g(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function m(t){$.notify({message:t},{allow_dismiss:!0,offset:{x:0,y:200},delay:1400,template:'<div data-notify="container" class="col-xs-11 col-sm-3 alert text-center note" role="alert"><span data-notify="dismiss"><span data-notify="message">{2}</span></span></div>'})}function y(t){$("#extra").css("opacity","1"),setTimeout(function(){$("#extxt").focus()},5),$("#extxt").on("input",function(){t.data("symbol")||t.data("symbol",t.text()),t.removeClass("btn-default"),t.addClass("btn-primary"),t.text(F)}),$(document).keypress(function(i){13==i.which&&t.click()})}function x(t){$("#extra").css("opacity","0"),$("#extxt").val(""),$("#extxt").off("input"),$(document).off("keypress"),t&&(t.addClass("btn-default"),t.removeClass("btn-primary"),t.text(t.data("symbol")))}function b(){return $("#extxt").val()}function oncheck(){x(I)}function k(t){$("#extxt").insertAtCaret(t),$("#extxt").focus()}var S="~",E="·",w="∨",C="⊃",L="≡";t.prototype.analyze=function(e){if(!this.isAtomic()){for(var s="נוסחה לא תקינה",r=!1,o=0,u=0;u<e.length;u++){var h=e.charAt(u);if(")"==h)o--;else if("("==h){if(o++,u+1<e.length){var c=e.charAt(u+1);if(!i(c)&&c!=S&&"("!=c)throw new Error(s)}}else if(0===o){if(n(h)){var f=e.slice(0,u),l=e.slice(u+1);if(this.con=h,this.sf1=new t(f),this.sf2=new t(l),!this.sf1.validateSub(f)||!this.sf2.validateSub(l))throw new Error(s);return}h===S&&(r=!0)}else if(o<0)throw new Error("סוגריים לא מאוזנים")}if(0!==o)throw new Error("סוגריים לא מאוזנים");if(r){var a=e.slice(1);if(e.charAt(0)!==S)throw new Error(s);return this.con=S,void(this.sf1=new t(a))}throw new Error(s)}},t.prototype.isAtomic=function(){return 1==this.lit.length&&i(this.lit)},t.prototype.isContradiction=function(){return this.con===E&&(this.sf1.isNegationOf(this.sf2)||this.sf2.isNegationOf(this.sf1))},t.prototype.isNegationOf=function(t){return this.con===S&&this.sf1.equals(t)},t.prototype.equals=function(t){if(!t)return!1;if(this.lit==t.lit)return!0;if(this.isAtomic())return!1;if(this.con==t.con){if(!n(this.con))return this.sf1.equals(t.sf1);if(this.sf1.equals(t.sf1)&&this.sf2.equals(t.sf2))return!0;if(e(this.con))return this.sf1.equals(t.sf2)&&this.sf2.equals(t.sf1)}return!1},t.prototype.combine=function(i,e){if(n(e))return f=new t("p"),f.con=e,f.sf1=this,f.sf2=i,f.lit=this.wrap()+e+i.wrap(),f},t.prototype.negate=function(){return f=new t("p"),f.con=S,f.sf1=this,f.lit=S+this.wrap(),f},t.prototype.wrap=function(){return n(this.con)?"("+this.lit+")":this.lit},t.prototype.validateSub=function(t){return this.isAtomic()||!n(this.con)||t!==r(t)},t.prototype.toString=function(){return"<Formula: "+this.lit+">"},o.prototype.index=function(){return this.formulas.length-1},o.prototype.nesting=function(){return this.nestingStack.length},o.prototype.openIndex=function(){return this.nestingStack[this.nestingStack.length-1]},o.prototype.push=function(t,i,n){this.formulas.push(t),i?this.nestingStack.push(this.index()):n&&this.reverseStack.push(this.nestingStack.pop()),this.nestingLevels.push(this.nesting())},o.prototype.pop=function(){if(0!=this.index()){var t=this.nesting(),i=this.index();this.formulas.pop(),this.nestingLevels.pop(),this.nestingLevels[this.index()]!=t&&(this.openIndex()==i?this.nestingStack.pop():this.nestingStack.push(this.reverseStack.pop()))}},o.prototype.isOpenNested=function(t){var i=this.nestingLevels[t];if(i>0&&i<=this.nesting()){var n=this.nestingStack[i-1];return t>=n}return!1},o.prototype.isOnCurrentLevel=function(t){var i=this.nesting();return i==this.nestingLevels[t]&&(0==i||this.isOpenNested(t))},o.prototype.getFormula=function(t){if(t>0&&t<=this.index())return this.formulas[t]},o.prototype.toString=function(){for(var t="",i=1;i<this.formulas.length;i++)t+="["+this.nestingLevels[i]+"] "+i+". "+this.formulas[i]+"\n";return t},o.prototype.impE=function(t,i){if(this.isOnCurrentLevel(t)&&this.isOnCurrentLevel(i)){_impE=function(t,i){if(t&&t.con==C&&t.sf1.equals(i))return t.sf2};var n=this.getFormula(t),e=this.getFormula(i),s=_impE(n,e);return s||(s=_impE(e,n)),s?(this.lastSymbol="E "+C+" "+t+","+i,this.push(s),s):void 0}},o.prototype.conE=function(t){if(this.isOnCurrentLevel(t)){var i=this.getFormula(t);if(i&&i.con==E){var n=[i.sf1,i.sf2];return this.lastSymbol="E "+E+" "+t,this.push(n[0]),this.push(n[1]),n}}},o.prototype.disE=function(t,i,n){if(this.isOnCurrentLevel(t)&&this.isOnCurrentLevel(i)&&this.isOnCurrentLevel(n)){_disE=function(t,i,n){if(i.sf2.equals(n.sf2)&&t.equals(i.sf1.combine(n.sf1,w)))return i.sf2};var e=this.getFormula(t),s=this.getFormula(i),r=this.getFormula(n),o=null;if(e&&s&&r){if(e.con==w&&s.con==C&&r.con==C)o=_disE(e,s,r);else if(s.con==w&&e.con==C&&r.con==C)o=_disE(s,e,r);else{if(r.con!=w||s.con!=C||e.con!=C)return;o=_disE(r,s,e)}return this.lastSymbol="E "+w+" "+t+","+i+","+n,this.push(o),o}}},o.prototype.eqvE=function(t){if(this.isOnCurrentLevel(t)){var i=this.getFormula(t);if(i&&i.con==L){var n=[i.sf1.combine(i.sf2,C),i.sf2.combine(i.sf1,C)];return this.lastSymbol="E "+L+" "+t,this.push(n[0]),this.push(n[1]),n}}},o.prototype.negE=function(t){if(this.isOnCurrentLevel(t)){var i=this.getFormula(t);if(i&&i.con==S&&i.sf1.con==S){var n=i.sf1.sf1;return this.lastSymbol="E "+S+" "+t,this.push(n),n}}},o.prototype.conI=function(t,i){if(this.isOnCurrentLevel(t)&&this.isOnCurrentLevel(i)){var n=this.getFormula(t),e=this.getFormula(i);if(n&&e){var s=n.combine(e,E);return this.lastSymbol="I "+E+" "+t+","+i,this.push(s),s}}},o.prototype.disI=function(t,i){if(this.isOnCurrentLevel(t)){var n=this.getFormula(t);if(n&&i){var e=n.combine(i,w);return this.lastSymbol="I "+w+" "+t,this.push(e),e}}},o.prototype.eqvI=function(t,i){if(this.isOnCurrentLevel(t)&&this.isOnCurrentLevel(i)){var n=this.getFormula(t),e=this.getFormula(i);if(n&&e&&n.con==C&&e.con==C&&n.sf1.equals(e.sf2)&&e.sf1.equals(n.sf2)){var s=n.sf1.combine(n.sf2,L);return this.lastSymbol="I "+L+" "+t+","+i,this.push(s),s}}},o.prototype.impI=function(){if(this.nesting()>0){var t=this.getFormula(this.openIndex()),i=this.getFormula(this.index());if(t&&i){var n=t.combine(i,C);return this.lastSymbol="I "+C+" "+this.openIndex()+"-"+this.index(),this.push(n,!1,!0),n}}},o.prototype.negI=function(){if(this.nesting()>0){var t=this.getFormula(this.openIndex()),i=this.getFormula(this.index());if(t&&i&&i.isContradiction()){var n=t.negate();return this.lastSymbol="I "+S+" "+this.openIndex()+"-"+this.index(),this.push(n,!1,!0),n}}},o.prototype.hyp=function(t){return this.lastSymbol="hyp",this.push(t,!0),t},o.prototype.rep=function(t){var i=this.getFormula(t);if(i){if(this.isOnCurrentLevel(t))throw Error("שורה "+t+" כבר נמצאת ברמה הנוכחית");if(this.nestingLevels[t]>0&&!this.isOpenNested(t))throw Error("שורה "+t+" נמצאת בתת הוכחה אחרת");return this.lastSymbol="rep "+t,this.push(i),i}};var O=new o,I=null,F="OK";jQuery.fn.extend({insertAtCaret:function(t){return this.each(function(i){if(document.selection){this.focus();var n=document.selection.createRange();n.text=t,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var e=this.selectionStart,s=this.selectionEnd,r=this.scrollTop;this.value=this.value.substring(0,e)+t+this.value.substring(s,this.value.length),this.focus(),this.selectionStart=e+t.length,this.selectionEnd=e+t.length,this.scrollTop=r}else this.value+=t,this.focus()})}}),$(document).ready(function(){$("#imp-e").click(function(){u($(this),O.impE,2)}),$("#con-e").click(function(){u($(this),O.conE,1)}),$("#dis-e").click(function(){u($(this),O.disE,3)}),$("#eqv-e").click(function(){u($(this),O.eqvE,1)}),$("#neg-e").click(function(){u($(this),O.negE,1)}),$("#imp-i").click(function(){u($(this),O.impI,0)}),$("#con-i").click(function(){u($(this),O.conI,2)}),$("#dis-i").click(function(){u($(this),O.disI,1,!0)}),$("#eqv-i").click(function(){u($(this),O.eqvI,2)}),$("#neg-i").click(function(){u($(this),O.negI,0)}),$("#hyp").click(function(){u($(this),O.hyp,0,!0)}),$("#rep").click(function(){u($(this),O.rep,1,!1,!0)}),$("#rem").click(function(){p(),$(this).blur()}),$("#neg").click(function(){k("~")}),$("#con").click(function(){k("·")}),$("#dis").click(function(){k("∨")}),$("#imp").click(function(){k("⊃")}),$("#eqv").click(function(){k("≡")})});
