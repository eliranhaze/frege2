function n(){return mn.length}function t(){return parseInt(mn[mn.length-1])}function e(){H(),gn=parseInt(mn.pop()),c()}function r(){mn.push(parseInt(U())),c()}function c(){xn[U()]=n()}function s(n){return mn.length>0&&parseInt(n)>=mn[0]}function f(t){var e=n();return e===o(t)&&(0===e||s(t))}function o(n){n=parseInt(n);var t=0;for(line in xn)line=parseInt(line),line>t&&line<=n&&(t=line);return xn[t]}function u(n,t){return n.length>t.length?l(n,t):l(t,n)}function l(n,t){var e=T(n);if(e.con===vn&&j(e.sf1)===j(t))return j(e.sf2)}function h(n){var t=T(n);if(t.con===dn)return[j(t.sf1),j(t.sf2)]}function d(n,t,e){var i=T(n),r=T(t),c=T(e);return i.con===$n&&r.con===vn&&c.con===vn?v(i,r,c):r.con===$n&&i.con===vn&&c.con===vn?v(r,i,c):c.con===$n&&r.con===vn&&i.con===vn?v(c,r,i):void 0}function v(n,t,e){if(t.sf2===e.sf2&&(n.sf1===t.sf1&&n.sf2===e.sf1||n.sf1===e.sf1&&n.sf2===t.sf1))return j(t.sf2)}function p(n){var t=T(n);if(t.con===pn)return[t.sf1+vn+t.sf2,t.sf2+vn+t.sf1]}function m(n){var t=T(n);if(t.con===hn&&(a2=T(t.sf1),a2.con===hn))return j(a2.sf1)}function x(){if(n()>0)return formulas=rn([t(),R()]),e(),K(formulas[0])+vn+K(formulas[1])}function g(n,t){return K(n)+dn+K(t)}function k(n,t){return K(n)+$n+K(t)}function y(n,t){var e=T(n),i=T(t);if(e.con===vn&&i.con===vn&&e.sf1===i.sf2&&e.sf2===i.sf1)return e.sf1+pn+i.sf2}function b(){if(n()>0&&(formulas=rn([t(),R()]),w(formulas[1])))return e(),hn+K(formulas[0])}function C(n){return r(),n}function I(n){return n}function q(n){var t={valid:!1,literal:"",err:""},e=j(n).replace(/ /g,"");return E(e)?(t.valid=!0,t.literal=e):(a=T(e),""==a.con?(t.valid=!1,t.err=a.err):(t.valid=!0,t.literal=a.lit)),t}function A(n){return E(n)||!L(T(n).con)||n!==j(n)}function E(n){return 1===n.length&&n===n.toLowerCase()&&n.toLowerCase()!==n.toUpperCase()}function w(n){var t=T(n);if(t.con===dn)return asf1=T(t.sf1),asf2=T(t.sf2),S(asf1,asf2)||S(asf2,asf1)}function S(n,t){return n.con===hn&&j(n.sf1)===t.lit}function T(n){for(var t=j(n).replace(/ /g,""),e={lit:t,con:"",sf1:"",sf2:""},i="נוסחה לא תקינה",r=!1,c=0,s=0;s<t.length;s++){var f=t.charAt(s);if(")"===f)c--;else if("("===f){if(c++,s+1<t.length&&(next=t.charAt(s+1),!E(next)&&next!==hn&&"("!==next))return e.err=i,e}else if(0===c){if(L(f))return sf1=t.slice(0,s),sf2=t.slice(s+1),A(sf1)&&A(sf2)&&q(sf1).valid&&q(sf2).valid?(e.con=f,e.sf1=t.slice(0,s),e.sf2=t.slice(s+1),e):(e.err=i,e);f===hn&&(r=!0)}else if(c<0)return e.err="סוגריים לא מאוזנים",e}return 0!==c?(e.err="סוגריים לא מאוזנים",e):r?(sf=t.slice(1),t.charAt(0)===hn&&q(sf).valid?(e.con=hn,e.sf1=t.slice(1),e):(e.err=i,e)):(e.err=i,e)}function j(n){if("("===n.charAt(0)&&")"===n.charAt(n.length-1))for(var t=0,e=0;e<n.length;e++){var i=n.charAt(e);if(")"===i){if(t--,0===t)return e===n.length-1?j(n.slice(1,n.length-1)):n}else"("===i&&t++}return n}function L(n){return n===dn||n===$n||n===vn||n===pn}function K(n){return n.length>1&&T(n).con!=hn?"("+n+")":n}function O(n,t,e,i,r,c){kn=null,r?n.text()===yn?Q(t,e,i,r,c)&&on(n):(on(n),z(e)&&(fn(n),kn=n)):Q(t,e,i,r,c),n.blur()}function Q(n,t,e,i,r){if(z(t,r)){if(checked=cn(),formulas=rn(checked),i){if(text=un(),!text)return sn("יש להזין נוסחה");if(result=q(text),!result.valid)return sn(result.err);formulas.push(result.literal)}if(consq=n.apply(this,formulas),consq){var c=U(),s=e(checked);consq instanceof Array||(consq=[consq]);for(var f=0;f<consq.length;f++)D(c+f,consq[f],s);return _(),$.notifyClose(),!0}return sn(t>0?"לא ניתן להשתמש בכלל זה עבור השורות שנבחרו":"לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function R(){return $("#deduction >tbody >tr").length}function U(){return R()+1}function _(){$("input[type=checkbox]").prop("checked",!1)}function z(n,t){if(n>0){var e=cn();if(e.length!=n){var i=["","שורה אחת","שתי שורות","שלוש שורות"];return sn("יש לבחור "+i[n]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(t)return B(e);for(var r=0;r<e.length;r++)if(!f(e[r]))return sn("שורה "+e[r]+" מחוץ לרמה הנוכחית"),!1}else _();return!0}function B(n){var t=n[0];return f(t)?(sn("שורה "+t+" כבר נמצאת ברמה הנוכחית"),!1):!(o(t)>0&&!s(t))||(sn("שורה "+t+" נמצאת בתת הוכחה אחרת"),!1)}function D(t,e,r){for(i=0;i<n();i++)e=G(e,t,n()-i);$("#deduction tr:last").after('<tr id="row'+t+'"><td class="dd-num""><input type="checkbox" id="cb'+t+'" name="'+t+'" onclick="oncheck()">'+t+'. </input></td><td id="f'+t+'">'+e+'</td><td class="dd-just">'+r+"</td></tr>")}function F(){_(),$("#row"+R()).remove()}function G(n,t,e){return'<div class="dd-hyp" id="nst'+t+e+'">'+n+"</div>"}function H(){$("#nst"+R()+n()).addClass("dd-hyp-end")}function J(n){return"E ⊃ "+n[0]+","+n[1]}function M(n){return"E · "+n[0]}function N(n){return"E ∨ "+n[0]+","+n[1]+","+n[2]}function P(n){return"E ≡ "+n[0]}function V(n){return"E ~ "+n[0]}function W(){return"I ⊃ "+gn+"-"+R()}function X(n){return"I · "+n[0]+","+n[1]}function Y(n){return"I ∨ "+n[0]}function Z(n){return"I ≡ "+n[0]+","+n[1]}function nn(){return"I ~ "+gn+"-"+R()}function tn(){return"hyp"}function en(n){return"rep "+n[0]}function rn(n){for(var t=[],e=0;e<n.length;e++)t.push($("#f"+n[e]).text());return t}function cn(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function sn(n){$.notify({message:n},{allow_dismiss:!0,delay:1400,template:'<div data-notify="container" class="col-xs-11 col-sm-3 alert text-center note" role="alert"><span data-notify="dismiss"><span data-notify="message">{2}</span></span></div>'})}function fn(n){$("#extra").css("opacity","1"),setTimeout(function(){$("#extxt").focus()},5),$("#extxt").on("input",function(){n.data("symbol")||n.data("symbol",n.text()),n.removeClass("btn-default"),n.addClass("btn-primary"),n.text(yn)}),$(document).keypress(function(t){13==t.which&&n.click()})}function on(n){$("#extra").css("opacity","0"),$("#extxt").val(""),$("#extxt").off("input"),$(document).off("keypress"),n&&(n.addClass("btn-default"),n.removeClass("btn-primary"),n.text(n.data("symbol")))}function un(){return $("#extxt").val()}function ln(){on(kn)}function an(n){$("#extxt").insertAtCaret(n),$("#extxt").focus()}var hn="~",dn="·",$n="∨",vn="⊃",pn="≡",mn=[],xn=[];xn[0]=0;var gn=null,kn=null,yn="OK";jQuery.fn.extend({insertAtCaret:function(n){return this.each(function(t){if(document.selection){this.focus();var e=document.selection.createRange();e.text=n,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var i=this.selectionStart,r=this.selectionEnd,c=this.scrollTop;this.value=this.value.substring(0,i)+n+this.value.substring(r,this.value.length),this.focus(),this.selectionStart=i+n.length,this.selectionEnd=i+n.length,this.scrollTop=c}else this.value+=n,this.focus()})}}),$(document).ready(function(){$("#imp-e").click(function(){O($(this),u,2,J)}),$("#con-e").click(function(){O($(this),h,1,M)}),$("#dis-e").click(function(){O($(this),d,3,N)}),$("#eqv-e").click(function(){O($(this),p,1,P)}),$("#neg-e").click(function(){O($(this),m,1,V)}),$("#imp-i").click(function(){O($(this),x,0,W)}),$("#con-i").click(function(){O($(this),g,2,X)}),$("#dis-i").click(function(){O($(this),k,1,Y,!0)}),$("#eqv-i").click(function(){O($(this),y,2,Z)}),$("#neg-i").click(function(){O($(this),b,0,nn)}),$("#hyp").click(function(){O($(this),C,0,tn,!0)}),$("#rep").click(function(){O($(this),I,1,en,!1,!0)}),$("#rem").click(function(){F(),$(this).blur()}),$("#neg").click(function(){an("~")}),$("#con").click(function(){an("·")}),$("#dis").click(function(){an("∨")}),$("#imp").click(function(){an("⊃")}),$("#eqv").click(function(){an("≡")})});
