function t(t,i){this.con=null,this.s1=null,this.s2=null,this.lit=e(t),this.an(this.lit)}function i(t){return t.toLowerCase()!=t.toUpperCase()}function n(t){return t==k||t==x||t==S||t==E}function s(t){return t==k||t==x||t==E}function e(t){return r(t).replace(/ /g,"")}function r(t){if("("==t.charAt(0)&&")"==t.charAt(t.length-1))for(var i=0,n=0;n<t.length;n++){var s=t.charAt(n);if(")"==s){if(i--,0==i)return n==t.length-1?r(t.slice(1,t.length-1)):t}else"("==s&&i++}return t}function o(){this.fs=[null],this.nl=[0],this.ns=[],this.rs=[],this.ls=""}function h(t,i,n,s,e){w=null,s?t.text()==C?u(i,n,s)&&y(t):(y(t),l(n)&&(d(t),w=t)):u(i,n,s,e),t.blur()}function u(i,n,s,e){if(l(n,e)){var r=g();if(s){var o=m();if(!o)return errmsg("יש להזין נוסחה");try{var h=new t(o)}catch(t){return errmsg(t.message)}r.push(h)}var f=dd.nesting();try{var u=i.apply(dd,r)}catch(t){return errmsg(t.message)}if(u){u instanceof Array||(u=[u]);for(var a=0;a<u.length;a++)addRow(u[a].lit,dd.ls,!1,dd.idx()-u.length+a+1);return f>dd.nesting()&&v(dd.idx()-1,f),c(),$.notifyClose(),!0}return n>0?errmsg("לא ניתן להשתמש בכלל זה עבור השורות שנבחרו"):errmsg("לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function c(){$("input[type=checkbox]").prop("checked",!1)}function l(t,i){if(t>0){var n=g();if(n.length!=t){var s=["","שורה אחת","שתי שורות","שלוש שורות"];return errmsg("יש לבחור "+s[t]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(i)return!0;for(var e=0;e<n.length;e++)if(!dd.ic(n[e]))return errmsg("שורה "+n[e]+" מחוץ לרמה הנוכחית"),!1}else c();return!0}function addRow(i,n,s,e){if(s){var r="";n="prem",dd.push(new t(i)),e=dd.idx()}else var r="r"+e;for(var o=dd.nesting(),h=0;h<o;h++)i=p(i,e,o-h);$("#deduction tr:last").after('<tr id="'+r+'"><td class="dd-num""><input type="checkbox" id="cb'+e+'" name="'+e+'" onclick="oc()">'+e+'. </input></td><td id="f'+e+'">'+i+'</td><td class="dd-just">'+n+"</td></tr>")}function a(){var t=dd.idx();if(0!=$("#r"+t).length){$("#r"+t).remove(),c();var i=dd.nesting();dd.pop(),dd.nesting()>i&&v(dd.idx(),dd.nesting())}}function p(t,i,n){return'<div class="dd-hyp" id="nst'+i+n+'">'+t+"</div>"}function v(t,i){$("#nst"+t+i).toggleClass("dd-hyp-end")}function g(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function d(t){$("#extra").css("opacity","1"),setTimeout(function(){$("#ftxt").focus()},5),$("#ftxt").on("input",function(){t.data("symbol")||t.data("symbol",t.text()),t.removeClass("btn-default"),t.addClass("btn-primary"),t.text(C)}),$(document).keypress(function(i){13==i.which&&t.click()})}function y(t){$("#extra").css("opacity","0"),$("#ftxt").val(""),$("#ftxt").off("input"),$(document).off("keypress"),t&&(t.addClass("btn-default"),t.removeClass("btn-primary"),t.text(t.data("symbol")))}function m(){return $("#ftxt").val()}function oc(){y(w)}var b="~",k="·",x="∨",S="⊃",E="≡";t.prototype.an=function(s){if(!this.ia()){for(var e="נוסחה לא תקינה",r=!1,o=0,h=0;h<s.length;h++){var f=s.charAt(h);if(")"==f)o--;else if("("==f){if(o++,h+1<s.length){var u=s.charAt(h+1);if(!i(u)&&u!=b&&"("!=u)throw new Error(e)}}else if(0==o){if(n(f)){var c=s.slice(0,h),l=s.slice(h+1);if(this.con=f,this.s1=new t(c),this.s2=new t(l),!this.s1.vs(c)||!this.s2.vs(l))throw new Error(e);return}f==b&&(r=!0)}else if(o<0)throw new Error("סוגריים לא מאוזנים")}if(0!==o)throw new Error("סוגריים לא מאוזנים");if(r){var a=s.slice(1);if(s.charAt(0)!==b)throw new Error(e);return this.con=b,void(this.s1=new t(a))}throw new Error(e)}},t.prototype.ia=function(){return 1==this.lit.length&&i(this.lit)},t.prototype.icn=function(){return this.con==k&&(this.s1.ing(this.s2)||this.s2.ing(this.s1))},t.prototype.ing=function(t){return this.con==b&&this.s1.eq(t)},t.prototype.eq=function(t){if(!t)return!1;if(this.lit==t.lit)return!0;if(this.ia())return!1;if(this.con==t.con){if(!n(this.con))return this.s1.eq(t.s1);if(this.s1.eq(t.s1)&&this.s2.eq(t.s2))return!0;if(s(this.con))return this.s1.eq(t.s2)&&this.s2.eq(t.s1)}return!1},t.prototype.cm=function(i,s){if(n(s))return f=new t("p"),f.con=s,f.s1=this,f.s2=i,f.lit=this.wr()+s+i.wr(),f},t.prototype.ng=function(){return f=new t("p"),f.con=b,f.s1=this,f.lit=b+this.wr(),f},t.prototype.wr=function(){return n(this.con)?"("+this.lit+")":this.lit},t.prototype.vs=function(t){return this.ia()||!n(this.con)||t!==r(t)},t.prototype.toString=function(){return this.lit},o.prototype.idx=function(){return this.fs.length-1},o.prototype.nesting=function(){return this.ns.length},o.prototype.oi=function(){return this.ns[this.ns.length-1]},o.prototype.push=function(t,i,n){this.fs.push(t),i?this.ns.push(this.idx()):n&&this.rs.push(this.ns.pop()),this.nl.push(this.nesting())},o.prototype.pop=function(){if(0!=this.idx()){var t=this.nesting(),i=this.idx();this.fs.pop(),this.nl.pop(),this.nl[this.idx()]!=t&&(this.oi()==i?this.ns.pop():this.ns.push(this.rs.pop()))}},o.prototype.io=function(t){var i=this.nl[t];if(i>0&&i<=this.nesting()){var n=this.ns[i-1];return t>=n}return!1},o.prototype.ic=function(t){var i=this.nesting();return i==this.nl[t]&&(0==i||this.io(t))},o.prototype.get=function(t){if(t>0&&t<=this.idx())return this.fs[t]},o.prototype.toString=function(){for(var t="",i=1;i<this.fs.length;i++)t+="["+this.nl[i]+"] "+i+". "+this.fs[i]+"\n";return t},o.prototype.impE=function(t,i){if(this.ic(t)&&this.ic(i)){_impE=function(t,i){if(t&&t.con==S&&t.s1.eq(i))return t.s2};var n=this.get(t),s=this.get(i),e=_impE(n,s);return e||(e=_impE(s,n)),e?(this.ls="E "+S+" "+t+","+i,this.push(e),e):void 0}},o.prototype.conE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==k){var n=[i.s1,i.s2];return this.ls="E "+k+" "+t,this.push(n[0]),this.push(n[1]),n}}},o.prototype.disE=function(t,i,n){if(this.ic(t)&&this.ic(i)&&this.ic(n)){_disE=function(t,i,n){if(i.s2.eq(n.s2)&&t.eq(i.s1.cm(n.s1,x)))return i.s2};var s=this.get(t),e=this.get(i),r=this.get(n),o=null;if(s&&e&&r){if(s.con==x&&e.con==S&&r.con==S)o=_disE(s,e,r);else if(e.con==x&&s.con==S&&r.con==S)o=_disE(e,s,r);else{if(r.con!=x||e.con!=S||s.con!=S)return;o=_disE(r,e,s)}return this.ls="E "+x+" "+t+","+i+","+n,this.push(o),o}}},o.prototype.eqvE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==E){var n=[i.s1.cm(i.s2,S),i.s2.cm(i.s1,S)];return this.ls="E "+E+" "+t,this.push(n[0]),this.push(n[1]),n}}},o.prototype.negE=function(t){if(this.ic(t)){var i=this.get(t);if(i&&i.con==b&&i.s1.con==b){var n=i.s1.s1;return this.ls="E "+b+" "+t,this.push(n),n}}},o.prototype.conI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.get(t),s=this.get(i);if(n&&s){var e=n.cm(s,k);return this.ls="I "+k+" "+t+","+i,this.push(e),e}}},o.prototype.disI=function(t,i){if(this.ic(t)){var n=this.get(t);if(n&&i){var s=n.cm(i,x);return this.ls="I "+x+" "+t,this.push(s),s}}},o.prototype.eqvI=function(t,i){if(this.ic(t)&&this.ic(i)){var n=this.get(t),s=this.get(i);if(n&&s&&n.con==S&&s.con==S&&n.s1.eq(s.s2)&&s.s1.eq(n.s2)){var e=n.s1.cm(n.s2,E);return this.ls="I "+E+" "+t+","+i,this.push(e),e}}},o.prototype.impI=function(){if(this.nesting()>0){var t=this.get(this.oi()),i=this.get(this.idx());if(t&&i){var n=t.cm(i,S);return this.ls="I "+S+" "+this.oi()+"-"+this.idx(),this.push(n,!1,!0),n}}},o.prototype.negI=function(){if(this.nesting()>0){var t=this.get(this.oi()),i=this.get(this.idx());if(t&&i&&i.icn()){var n=t.ng();return this.ls="I "+b+" "+this.oi()+"-"+this.idx(),this.push(n,!1,!0),n}}},o.prototype.hyp=function(t){return this.ls="hyp",this.push(t,!0),t},o.prototype.rep=function(t){var i=this.get(t);if(i){if(this.ic(t))throw Error("שורה "+t+" כבר נמצאת ברמה הנוכחית");if(this.nl[t]>0&&!this.io(t))throw Error("שורה "+t+" נמצאת בתת הוכחה אחרת");return this.ls="rep "+t,this.push(i),i}};var dd=new o,w=null,C="OK";$(document).ready(function(){$("#imp-e").click(function(){h($(this),dd.impE,2)}),$("#con-e").click(function(){h($(this),dd.conE,1)}),$("#dis-e").click(function(){h($(this),dd.disE,3)}),$("#eqv-e").click(function(){h($(this),dd.eqvE,1)}),$("#neg-e").click(function(){h($(this),dd.negE,1)}),$("#imp-i").click(function(){h($(this),dd.impI,0)}),$("#con-i").click(function(){h($(this),dd.conI,2)}),$("#dis-i").click(function(){h($(this),dd.disI,1,!0)}),$("#eqv-i").click(function(){h($(this),dd.eqvI,2)}),$("#neg-i").click(function(){h($(this),dd.negI,0)}),$("#hyp").click(function(){h($(this),dd.hyp,0,!0)}),$("#rep").click(function(){h($(this),dd.rep,1,!1,!0)}),$("#rem").click(function(){a(),$(this).blur()})});
