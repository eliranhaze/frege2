function t(){return dt.length}function n(){return dt[dt.length-1]}function e(){F(),dt.pop()}function r(){dt.push($t+1)}function c(t){return dt.length>0&&parseInt(t)>=dt[0]}function f(n){var i=t();return i===o(n)&&(0===i||c(n))}function o(t){return pt[t]}function u(t,n){var i=I(t),e=I(n),r=s(i,e);return r?r:s(e,i)}function s(t,n){if(t.con===ht&&E(t.sf1,n.lit))return q(t.sf2)}function a(t){var n=I(t);if(n.con===at)return[q(n.sf1),q(n.sf2)]}function l(t,n,i){var e=I(t),r=I(n),c=I(i);return e.con===lt&&r.con===ht&&c.con===ht?h(e,r,c):r.con===lt&&e.con===ht&&c.con===ht?h(r,e,c):c.con===lt&&r.con===ht&&e.con===ht?h(c,r,e):void 0}function h(t,n,i){if(E(n.sf2,i.sf2)&&(E(t.sf1,n.sf1)&&E(t.sf2,i.sf1)||E(t.sf1,i.sf1)&&E(t.sf2,n.sf1)))return q(n.sf2)}function v(t){var n=I(t);if(n.con===vt)return[n.sf1+ht+n.sf2,n.sf2+ht+n.sf1]}function d(t){var n=I(t);if(n.con===st){var i=I(n.sf1);if(i.con===st)return q(i.sf1)}}function p(){if(t()>0){var i=it([n(),$t]);return e(),L(i[0])+ht+L(i[1])}}function g(t,n){return L(t)+at+L(n)}function m(t,n){return L(t)+lt+L(n)}function k(t,n){var i=I(t),e=I(n);if(i.con===ht&&e.con===ht&&E(i.sf1,e.sf2)&&E(i.sf2,e.sf1))return i.sf1+vt+i.sf2}function x(){if(t()>0){var i=it([n(),$t]);if(A(i[1]))return e(),st+L(i[0])}}function y(t){return r(),t}function b(t){return t}function C(t){var n={valid:!1,lit:"",err:""},i=R(t);if(w(i))n.valid=!0,n.lit=i;else{var e=I(i);""==e.con?(n.valid=!1,n.err=e.err):(n.valid=!0,n.lit=e.lit)}return n}function S(t){return w(t)||!T(I(t).con)||t!==q(t)}function w(t){return 1===t.length&&t===t.toLowerCase()&&t.toLowerCase()!==t.toUpperCase()}function A(t){var n=I(t);if(n.con===at){var i=I(n.sf1),e=I(n.sf2);return N(i,e)||N(e,i)}return!1}function N(t,n){return t.con===st&&E(t.sf1,n.lit)}function E(t,n){var i=I(t),e=I(n);if(i.lit===e.lit)return!0;if(w(t))return!1;if(i.con===e.con){if(E(i.sf1,e.sf1)&&E(i.sf2,e.sf2))return!0;if(j(i.con))return E(i.sf1,e.sf2)&&E(i.sf2,e.sf1)}return!1}function I(t){var n=R(t),i={lit:n,con:"",sf1:"",sf2:""};if(w(n))return i;for(var e="נוסחה לא תקינה",r=!1,c=0,f=0;f<n.length;f++){var o=n.charAt(f);if(")"===o)c--;else if("("===o){if(c++,f+1<n.length){var u=n.charAt(f+1);if(!w(u)&&u!==st&&"("!==u)return i.err=e,i}}else if(0===c){if(T(o)){var s=n.slice(0,f),a=n.slice(f+1);return S(s)&&S(a)&&C(s).valid&&C(a).valid?(i.con=o,i.sf1=s,i.sf2=a,i):(i.err=e,i)}o===st&&(r=!0)}else if(c<0)return i.err="סוגריים לא מאוזנים",i}if(0!==c)return i.err="סוגריים לא מאוזנים",i;if(r){var l=n.slice(1);return n.charAt(0)===st&&C(l).valid?(i.con=st,i.sf1=l,i):(i.err=e,i)}return i.err=e,i}function R(t){return q(t).replace(/ /g,"")}function q(t){if("("===t.charAt(0)&&")"===t.charAt(t.length-1))for(var n=0,i=0;i<t.length;i++){var e=t.charAt(i);if(")"===e){if(n--,0===n)return i===t.length-1?q(t.slice(1,t.length-1)):t}else"("===e&&n++}return t}function T(t){return t===at||t===lt||t===ht||t===vt}function j(t){return t===at||t===lt||t===vt}function L(t){return t.length>1&&I(t).con!=st?"("+t+")":t}function K(t,n,i,e,r,c){gt=null,r?t.text()===mt?O(n,i,e,r,c)&&ft(t):(ft(t),U(i)&&(ct(t),gt=t)):O(n,i,e,r,c),t.blur()}function O(t,n,i,e,r){if(U(n,r)){var c=et(),f=it(c);if(e){var o=ot();if(!o)return rt("יש להזין נוסחה");var u=C(o);if(!u.valid)return rt(u.err);f.push(u.lit)}var s=i(c),a=t.apply(this,f);if(a){a instanceof Array||(a=[a]);for(var l=0;l<a.length;l++)z(a[l],s);return Q(),$.notifyClose(),!0}return rt(n>0?"לא ניתן להשתמש בכלל זה עבור השורות שנבחרו":"לא ניתן להשתמש בכלל זה במצב הנוכחי")}}function Q(){$("input[type=checkbox]").prop("checked",!1)}function U(t,n){if(t>0){var i=et();if(i.length!=t){var e=["","שורה אחת","שתי שורות","שלוש שורות"];return rt("יש לבחור "+e[t]+" בדיוק על מנת להשתמש בכלל זה"),!1}if(n)return _(i);for(var r=0;r<i.length;r++)if(!f(i[r]))return rt("שורה "+i[r]+" מחוץ לרמה הנוכחית"),!1}else Q();return!0}function _(t){var n=t[0];return f(n)?(rt("שורה "+n+" כבר נמצאת ברמה הנוכחית"),!1):!(o(n)>0&&!c(n))||(rt("שורה "+n+" נמצאת בתת הוכחה אחרת"),!1)}function z(n,i,e){if($t++,nesting=t(),pt[$t]=nesting,e){var r="";i="prem"}else var r="r"+$t;for(var c=0;c<nesting;c++)n=D(n,$t,nesting-c);$("#deduction tr:last").after('<tr id="'+r+'"><td class="dd-num""><input type="checkbox" id="cb'+$t+'" name="'+$t+'" onclick="oncheck()">'+$t+'. </input></td><td id="f'+$t+'">'+n+'</td><td class="dd-just">'+i+"</td></tr>")}function B(){if(0!=$("#r"+$t).length&&($("#r"+$t).remove(),Q(),removedRow=$t,removedRowNesting=o(removedRow),$t--,pt.pop(),o($t)!=removedRowNesting))if(n()===removedRow)dt.pop();else{for(tmpStack=[],lastNesting=0,i=$t;i>0;i--)if(pt[i]>lastNesting?(tmpStack.push(i),lastNesting=o(i)):pt[i]<lastNesting&&(tmpStack.pop(),lastNesting=o(i)),0==tmpStack.length){lastNestingStart=i+1;break}dt.push(lastNestingStart),F()}}function D(t,n,i){return'<div class="dd-hyp" id="nst'+n+i+'">'+t+"</div>"}function F(){$("#nst"+$t+t()).toggleClass("dd-hyp-end")}function G(t){return"E ⊃ "+t[0]+","+t[1]}function H(t){return"E · "+t[0]}function J(t){return"E ∨ "+t[0]+","+t[1]+","+t[2]}function M(t){return"E ≡ "+t[0]}function P(t){return"E ~ "+t[0]}function V(){return"I ⊃ "+n()+"-"+$t}function W(t){return"I · "+t[0]+","+t[1]}function X(t){return"I ∨ "+t[0]}function Y(t){return"I ≡ "+t[0]+","+t[1]}function Z(){return"I ~ "+n()+"-"+$t}function tt(){return"hyp"}function nt(t){return"rep "+t[0]}function it(t){for(var n=[],i=0;i<t.length;i++)n.push($("#f"+t[i]).text());return n}function et(){return $("input:checkbox:checked").map(function(){return this.name}).get()}function rt(t){$.notify({message:t},{allow_dismiss:!0,delay:1400,template:'<div data-notify="container" class="col-xs-11 col-sm-3 alert text-center note" role="alert"><span data-notify="dismiss"><span data-notify="message">{2}</span></span></div>'})}function ct(t){$("#extra").css("opacity","1"),setTimeout(function(){$("#extxt").focus()},5),$("#extxt").on("input",function(){t.data("symbol")||t.data("symbol",t.text()),t.removeClass("btn-default"),t.addClass("btn-primary"),t.text(mt)}),$(document).keypress(function(n){13==n.which&&t.click()})}function ft(t){$("#extra").css("opacity","0"),$("#extxt").val(""),$("#extxt").off("input"),$(document).off("keypress"),t&&(t.addClass("btn-default"),t.removeClass("btn-primary"),t.text(t.data("symbol")))}function ot(){return $("#extxt").val()}function oncheck(){ft(gt)}function ut(t){$("#extxt").insertAtCaret(t),$("#extxt").focus()}var st="~",at="·",lt="∨",ht="⊃",vt="≡",dt=[],pt=[];pt[0]=0;var $t=0,gt=null,mt="OK";jQuery.fn.extend({insertAtCaret:function(t){return this.each(function(n){if(document.selection){this.focus();var i=document.selection.createRange();i.text=t,this.focus()}else if(this.selectionStart||"0"==this.selectionStart){var e=this.selectionStart,r=this.selectionEnd,c=this.scrollTop;this.value=this.value.substring(0,e)+t+this.value.substring(r,this.value.length),this.focus(),this.selectionStart=e+t.length,this.selectionEnd=e+t.length,this.scrollTop=c}else this.value+=t,this.focus()})}}),$(document).ready(function(){$("#imp-e").click(function(){K($(this),u,2,G)}),$("#con-e").click(function(){K($(this),a,1,H)}),$("#dis-e").click(function(){K($(this),l,3,J)}),$("#eqv-e").click(function(){K($(this),v,1,M)}),$("#neg-e").click(function(){K($(this),d,1,P)}),$("#imp-i").click(function(){K($(this),p,0,V)}),$("#con-i").click(function(){K($(this),g,2,W)}),$("#dis-i").click(function(){K($(this),m,1,X,!0)}),$("#eqv-i").click(function(){K($(this),k,2,Y)}),$("#neg-i").click(function(){K($(this),x,0,Z)}),$("#hyp").click(function(){K($(this),y,0,tt,!0)}),$("#rep").click(function(){K($(this),b,1,nt,!1,!0)}),$("#rem").click(function(){B(),$(this).blur()}),$("#neg").click(function(){ut("~")}),$("#con").click(function(){ut("·")}),$("#dis").click(function(){ut("∨")}),$("#imp").click(function(){ut("⊃")}),$("#eqv").click(function(){ut("≡")})});
