{% extends "logic/question_base.html" %}

{% block question_text %}{{ question.text }}{% endblock %}
{% block question_instruction %}תשובה{% endblock %}

{% block question_content %}

<script>
$(document).ready(function() {
  {% if graded %}
    $('#answer').remove();
    $('#filelbl').remove();
    $('#unfile').remove();
  {% endif %}
});
window.resetE = function(e) {
    console.log('resetting ' + e);
    e.wrap('<form>').closest('form').get(0).reset();
    e.unwrap();
    _updateFile(e.get(0), true);
};
</script>

<div>
  <form id="ansform" enctype="multipart/form-data">{% csrf_token %}
    <textarea id="anstxt" name="anstxt" style="min-width: 100%; resize: none; padding: 4px;" rows=10 maxlength=1000 autofocus {% if graded %}disabled{% endif %}>{{answer}}</textarea>
    {% if question.has_file %}
    <div>
      <label class="btn btn-default btn-lg" id="filelbl">
        <span class="glyphicon glyphicon-folder-open"></span>
        העלאת קובץ <input type="file" name="file" id="file" style="display: none;">
      </label>
      <label id="filename" class="text-muted small">
        {% if filename %}קובץ: <a href="{{open_ans.upload.url}}">{{filename}}</a>
        {% elif not graded %} לא נבחר
        {% endif %}
      </label>
      <label id="upload-status" class="text-muted small"></label>
      <button id="unfile" type="button" class="btn btn-default btn-sm" onclick="resetE($('#file'));" style="display: {% if filename %}inline{%else %}none{% endif %};"><span class="glyphicon glyphicon-remove"></span></button>
      <input id="file-upd" name="file-upd" type="hidden" value="false">
    </div>
    {% endif %}
  </form>
</div>

{% if graded and open_ans %}
<div>
  <div class="page-header" style="margin-top: 0px;"></div>
  <p><b>ניקוד:</b> {{open_ans.grade|floatformat:-1}} מתוך 1
  {% if open_ans.comment %}
  <br><b>הערות:</b> {{open_ans.comment}}
  {% endif %}
  </p>
</div>
{% endif %}

<script>
  function isEmpty() {
      if (!$.trim($('#anstxt').val()) && !$('#file').val()) {
          return 'יש להזין תשובה{% if question.has_file %} או להעלות קובץ{% endif %}';
      }
  }
  function getPostData() {
      return new FormData($('#ansform')[0]);
  }
  function _validateFile(file) {
      if (!file) return true;
      var ext = file.name.split('.').pop().toLowerCase();
      if ($.inArray(ext, ['gif', 'png', 'jpg', 'jpeg', 'doc', 'docx', 'pdf']) < 0) {
          errmsg('ניתן להעלות רק מסמכים או תמונות');
          return false;
      } 
      if (file.size > {{maxfilesize}}) {
          errmsg('לא ניתן להעלות קובץ גדול מ-' + humansize({{maxfilesize}}));
          return false;
      }
      return true;
  }
  function _updateFile(e, reset) {
      var file = e.files[0];
      if (!_validateFile(file)) {
          return;
      }
      if (file) {
          var label = 'קובץ: ' + file.name;
          var sts = '[*לחצו אישור להעלאה]';
          $('#unfile').show();
      } else if (reset){
          var label = 'לא נבחר';
          var sts = '';
          $('#unfile').hide();
      } else {
          // user canceled browse
          return;
      }
      $('#filename').text(label);
      $('#upload-status').text(sts);
      $('#file-upd').val('true');
  }
  function ansOk() {
      if (($('#file').get(0) && $('#file').get(0).files[0]) || {% if filename %}true{% else %}false{% endif %}) {
          $('#upload-status').text('[קובץ הועלה בהצלחה]');
      }
  }
  $(document).on('change', ':file', function() {
      _updateFile(this);
  });
  function humansize(bytes) {
      var tmp = bytes;
      var units = ['', 'k', 'm', 'g'];
      var i = 0;
      while (tmp > 1024 && i < units.length - 1) {
          tmp /= 1024;
          i++;
      }
      return parseFloat(tmp.toFixed(1)) + units[i] + 'b';
  }
</script>
{% endblock question_content %} 
